services:
  traefik:
    image: traefik:v3.0
    command:
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --api.insecure=true
      - --providers.docker=true
      - --providers.file.filename=/certs/dynamic.yml
      - --providers.file.watch=true
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker/dev-certificates:/certs:ro
    networks:
      - ash_learning_network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  db:
    image: postgres:18
    environment:
      - "POSTGRES_USER=ash_learning"
      - "POSTGRES_PASSWORD=secret"
    volumes:
      - ./docker/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
      - postgres_data:/var/lib/postgresql
    ports:
      - "5436:5432"
    networks:
      - ash_learning_network

  mailpit:
    image: axllent/mailpit
    container_name: ash_learning_mailpit
    ports:
      - 1025:1025
      - 8025:8025
    networks:
      - ash_learning_network

  playwright:
    build:
      context: .
      dockerfile: ./docker/playwright/Dockerfile
      target: playwright-dev
      args:
        DOMAIN: ashlearning.dev
    ports:
      - "3000:3000"
    environment:
      - DISPLAY=:99
      - NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/mkcert-root-ca.crt
    extra_hosts:
      - "ashlearning.dev:host-gateway"
      - "app.ashlearning.dev:host-gateway"
      - "vite.ashlearning.dev:host-gateway"
    networks:
      - ash_learning_network
    init: true
    ipc: host
    depends_on:
      - traefik

volumes:
  postgres_data:

networks:
  ash_learning_network:
    name: ash_learning_network
    driver: bridge
