services:
  traefik:
    image: traefik:v3.0
    command:
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --api.insecure=true
      - --providers.docker=true
      - --providers.file.filename=/src/docker/dev-certificates/dynamic.yml
      - --providers.file.watch=true
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ash_learning_src:/src:ro
    env_file:
      - .env.development
    networks:
      - ash_learning_network

  web:
    container_name: ash_learning
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: dev
    command: iex -S mix phx.server
    ports:
      - "${PORT}"
      - "5173:5173"
    expose:
      - "4004" # Internal port for Traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.web.loadbalancer.server.port=4004"
      - "traefik.http.services.vite.loadbalancer.server.port=5173"

      - "traefik.http.routers.site.rule=Host(`${PHX_HOST}`)"
      - "traefik.http.routers.site.entrypoints=websecure"
      - "traefik.http.routers.site.service=web"
      - "traefik.http.routers.site.tls=true"

      - "traefik.http.routers.app.rule=Host(`${APP_HOST}`)"
      - "traefik.http.routers.app.entrypoints=websecure"
      - "traefik.http.routers.app.service=web"
      - "traefik.http.routers.app.tls=true"

      - "traefik.http.services.vite.loadbalancer.server.port=5173"
      - "traefik.http.services.vite.loadbalancer.server.scheme=http"
      - "traefik.http.services.vite.loadbalancer.passhostheader=true"
      - "traefik.http.routers.vite.rule=Host(`${VITE_HOST}`)"
      - "traefik.http.routers.vite.entrypoints=websecure"
      - "traefik.http.routers.vite.service=vite"
      - "traefik.http.routers.vite.tls=true"

    volumes:
      # Source code
      - ash_learning_src:/ash_learning

      # Dependencies and build artifacts
      - ash_learning_deps:/ash_learning/deps
      - ash_learning_build:/ash_learning/_build
      - node_modules_container:/ash_learning/assets/node_modules

      - node_modules_container:/ash_learning/assets/node_modules
      - /Users/andres/code/opensource/inertia-phoenix:/ash_learning/vendor/inertia-phoenix
      - /Users/andres/code/opensource/ash_authentication_phoenix:/ash_learning/vendor/ash_authentication_phoenix
      - /Users/andres/code/opensource/wayfinder:/ash_learning/vendor/wayfinder
      - /Users/andres/code/opensource/vitex:/ash_learning/vendor/vitex

      # IEx history
      - ~/.iex_history:/root/.iex_history
    working_dir: /ash_learning
    depends_on:
      - db
      - mailpit
    env_file:
      - .env.development
    environment:
      - MIX_ENV=dev
      - DB_HOST=db
      - DB_USER=ash_learning
      - DB_PASSWORD=secret
      - MAILPIT_SMTP_HOST=ash_learning_mailpit
      - MAILPIT_SMTP_PORT=1025
      - ERL_AFLAGS=-kernel shell_history enabled -kernel shell_history_path '"/root/.iex_history"'

    stdin_open: true
    tty: true
    networks:
      - ash_learning_network

  db:
    image: postgres:18
    environment:
      - "POSTGRES_USER=ash_learning"
      - "POSTGRES_PASSWORD=secret"
    volumes:
      - ./docker/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
      - postgres_data:/var/lib/postgresql
    ports:
      - "5436:5432"
    networks:
      - ash_learning_network

  mailpit:
    image: axllent/mailpit
    container_name: ash_learning_mailpit
    ports:
      - 1025:1025
      - 8025:8025
    networks:
      - ash_learning_network

volumes:
  postgres_data:
  node_modules_container:
  ash_learning_src:
  ash_learning_deps:
  ash_learning_build:

networks:
  ash_learning_network:
    name: ash_learning_network
    driver: bridge
